<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stops Viewer</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .incoming {
            color: green;
            font-weight: bold;
        }
        .not-incoming {
            color: gray;
        }
        .route-selector {
            margin: 20px 0;
            padding: 8px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function StopsViewer() {
            const [stops, setStops] = React.useState([]);
            const [busLocation, setBusLocation] = React.useState([]);
            const [status, setStatus] = React.useState('Select a route');
            const [selectedRoute, setSelectedRoute] = React.useState('');
            
            const fetchStops = async (routeId) => {
                if (!routeId) return;
                
                setStatus('Fetching stops...');
                const apiUrl = `/api/stops/${routeId}`;

                try {
                    const response = await fetch(apiUrl);
                    const result = await response.json();

                    if (result.status === 'success') {
                        setStops(result.data.stops);
                        setStatus('Stops fetched successfully.');
                    } else {
                        setStatus('Error fetching stops.');
                        console.error('API Error:', result.message);
                    }
                } catch (error) {
                    setStatus('Error fetching stops.');
                    console.error('Fetch Error:', error);
                }
            };

            const fetchLocation = async (routeId) => {
                if (!routeId) return;
                
                const apiUrl = `/api/vehicles/${routeId}`;

                try {
                    const response = await fetch(apiUrl);
                    const result = await response.json();

                    if (result.status === 'success') {
                        let incoming_stops = result.data.map(res => res['incoming_stop']);
                        setBusLocation(incoming_stops || []);
                    } else {
                        console.error('API Error:', result.message);
                    }
                } catch (error) {
                    console.error('Fetch Error:', error);
                }
            };

            React.useEffect(() => {
                if (selectedRoute) {
                    fetchStops(selectedRoute);
                    fetchLocation(selectedRoute);
                    
                    const intervalId = setInterval(() => fetchLocation(selectedRoute), 5000);
                    return () => clearInterval(intervalId);
                } else {
                    setStops([]);
                    setBusLocation([]);
                }
            }, [selectedRoute]);

            const handleRouteChange = (event) => {
                setSelectedRoute(event.target.value);
            };

            const getClassName = (stop) => {
                const isIncoming = busLocation.some(location => location.includes(stop));
                return isIncoming ? 'incoming' : 'not-incoming';
            };

            return (
                <div>
                    <h1>Bus Route Stops</h1>
                    
                    <select 
                        className="route-selector"
                        value={selectedRoute} 
                        onChange={handleRouteChange}
                    >
                        <option value="">Select Route</option>
                        <option value="30">Route 30</option>
                        <option value="81">Route 81</option>
                        <option value="90">Route 90</option>
                        <option value="33">Route 33</option>
                    </select>

                    <p>{status}</p>
                    
                    <ul>
                        {stops.length > 0 ? (
                            stops.map((stop, index) => (
                                <li key={index}>
                                    <p className={getClassName(stop)}>{stop}</p>
                                </li>
                            ))
                        ) : (
                            <li>No stops available.</li>
                        )}
                    </ul>
                </div>
            );
        }

        ReactDOM.render(<StopsViewer />, document.getElementById('root'));
    </script>
</body>
</html>